# Simple options
BINARY_NAME	=	my_program

SRC_FILES	=	src/main.c

LIBS	=
INCLUDES_FOLDERS	=

OTHER_PROJECTS_TO_BUILD	=

# Advanced options
OBJ_RELEASE_DESTINATION	=	./obj/release/
OBJ_DEBUG_DESTINATION	=	./obj/dev/

OBJ_RELEASE	=	$(SRC_FILES:%.c=$(OBJ_RELEASE_DESTINATION)%.o)
OBJ_DEBUG	=	$(SRC_FILES:%.c=$(OBJ_DEBUG_DESTINATION)%.o)

WARNING_FLAGS	=	-Wall -Wextra
OPTIMISATION_FLAG	=	-O3
MEMORY_SANITIZER_FLAGS	=	-fsanitize=address -fsanitize=undefined

COMPILATION_RELEASE_FLAGS	=	$(addprefix -I,$(INCLUDES_FOLDERS)) $(addprefix -l,$(LIBS)) $(OPTIMISATION_FLAG) $(WARNING_FLAGS) -DNDEBUG -march=native -flto
COMPILATION_DEBUG_FLAGS	=	$(addprefix -I,$(INCLUDES_FOLDERS)) $(addprefix -l,$(LIBS)) -g $(WARNING_FLAGS) $(MEMORY_SANITIZER_FLAGS) -fno-omit-frame-pointer

LINKING_RELEASE_FLAGS	=	$(addprefix -I,$(INCLUDES_FOLDERS)) $(addprefix -l,$(LIBS)) $(OPTIMISATION_FLAG) -flto -s
LINKING_DEBUG_FLAGS	=	$(addprefix -I,$(INCLUDES_FOLDERS)) $(addprefix -l,$(LIBS)) -g $(MEMORY_SANITIZER_FLAGS)

FINAL_BINARY_DESTINATION	=	./

COMPILER	=	gcc
LINKER	=	$(COMPILER)

FINAL_BINARY_PATH	=	$(addprefix $(FINAL_BINARY_DESTINATION),$(BINARY_NAME))

# Commands
RELEASE_COMPILATION	=	$(COMPILER) -c $< -o $@ $(COMPILATION_RELEASE_FLAGS)
DEBUG_COMPILATION	=	$(COMPILER) -c $< -o $@ $(COMPILATION_DEBUG_FLAGS)

RELEASE_LINKING	=	$(LINKER) -o $(FINAL_BINARY_PATH) $(OBJ_RELEASE) $(LINKING_RELEASE_FLAGS)
DEBUG_LINKING	=	$(LINKER) -o $(FINAL_BINARY_PATH) $(OBJ_DEBUG) $(LINKING_DEBUG_FLAGS)

# Rules
all:
	make $(FINAL_BINARY_PATH)

$(FINAL_BINARY_PATH):
	$(foreach PROJECT,$(OTHER_PROJECTS_TO_BUILD),make -C $(PROJECT))
	make $(OBJ_RELEASE)
	$(RELEASE_LINKING)

dev:
	$(foreach PROJECT,$(OTHER_PROJECTS_TO_BUILD),make -C $(PROJECT) dev)
	make $(OBJ_DEBUG)
	$(DEBUG_LINKING)

$(OBJ_RELEASE) : $(OBJ_RELEASE_DESTINATION)%.o : %.c
	@mkdir -p $(dir $@)
	$(RELEASE_COMPILATION)

$(OBJ_DEBUG) : $(OBJ_DEBUG_DESTINATION)%.o : %.c
	@mkdir -p $(dir $@)
	$(DEBUG_COMPILATION)

clean:
	rm -f $(OBJ_RELEASE)
	rm -f $(OBJ_DEBUG)

fclean:
	make clean
	rm -f $(FINAL_BINARY_PATH)

re:
	make fclean
	make dev
